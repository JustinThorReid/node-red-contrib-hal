<script type="text/javascript">
    RED.nodes.registerType('item', {
        category: 'Home Automation',
        color: '#EBA8FF',
        defaults: {
            config: {
                value: "Event config",
                type: "event-config",
                required: true
            },
            name:       { required: true },
            topic:      { value: "" },
            filter:     { value: false },
            identifier: { value: "" },
            rules:      {},
            output:     { value: false, required: true },
            outputValue:{ value: "payload", required: false },
            outputType: { required: true },
            bootstrap:  { value: false, required: true },
            bootstrapValue:{},
            bootstrapType: {},
            stateProperty: { required: true },
            outputs:    { value: 0 } //Storing if outputs is enabled.
        },
        inputs: 1,
        outputs: 0,
        icon: "hal-item.png",
        label: function () {
            return this.name || "item";
        },
        oneditprepare: function () {

            //Show/hide tooltips
            var numModify = 0;
            var numNumber = 0;

            function resizeRule(rule) {
                var newWidth = rule.width();
                rule.find('.red-ui-typedInput').typedInput("width",newWidth-25);
            }

            //Types
            var typeGreaterThan = {
                value: "gt",
                label: "Greater than",
                icon: "fa fa-angle-right",
                hasValue: true,
                validate: /^[0-9]*$/
            };
            var typeLessThan = {
                value: "lt",
                label: "Less than",
                icon: "fa fa-angle-left",
                hasValue: true,
                validate: /^[0-9]*$/
            };
            var typeAlways = {
                value: "always",
                label: "Always",
                hasValue: false
            };
            var typeOtherwise = {
                value: "otherwise",
                label: "Otherwise",
                hasValue: false
            };
            var typeDrop = {
                value: "drop",
                label: "Drop message",
                hasValue: false
            };
            var typeModify = {
                value: "modify",
                label: "Modify",
                icon: "fa fa-calculator",
                validate: /^[0-9.()\-+*/]*$/,
                hasValue: true
            };
            var typeNumber = {
                value: "toNumber",
                label: "Convert to number",
                hasValue: false
            }

            //Add property
            if (this.stateProperty) {
                $("#node-input-stateProperty").val(this.stateProperty);
                $('#node-input-stateProperty').trigger('change');                
            } else {
                $("#node-input-stateProperty").val("payload");
                $('#node-input-stateProperty').trigger('change');    
            }
            $('#node-input-stateProperty').typedInput({
                default: 'msg',
                types: ['msg']
            });

            //Rules
            $("#node-input-rule-container").editableList({
                addItem: function(container,i,opt) {
                    var rule = opt;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });

                    //Add rows
                    var row1 = $('<div/>').appendTo(container);
                    var row2 = $('<div/>',{style:"margin-top:8px;"}).appendTo(container);

                    //Add labels
                    var label1 = $('<div/>',{style:"display:inline-block;text-align:right; width:20px; padding-right:5px; box-sizing:border-box;"})
                        .appendTo(row1);
                    label1.append($('<i/>',{class:"fa fa-sign-in"}));
                    var label2 = $('<div/>',{style:"display:inline-block;text-align:right; width:20px; padding-right:5px; box-sizing:border-box;"})
                        .appendTo(row2);
                    label2.append($('<i/>',{class:"fa fa-sign-out"}));
                    //Add compare value field
                    var compareField = $('<input/>',{class:"node-input-rule-compare",type:"text"})
                        .appendTo(row1)
                        .attr("placeholder","if match")
                        .typedInput({
                            default:'num',
                            types:['str','num','bool','re',typeGreaterThan,typeLessThan,typeAlways,typeOtherwise],
                        });

                    //Add result value field
                    var resultField = $('<input/>',{class:"node-input-rule-result",type:"text"})
                        .appendTo(row2)
                        .attr("placeholder","change to")
                        .typedInput({
                            default:'str',
                            types:['str','num','bool',typeModify,typeNumber,typeDrop]
                        });
                    
                    //Add values
                    if (rule) {
                        compareField.typedInput('value',rule.cv);
                        compareField.typedInput('type',rule.ct);
                        resultField.typedInput('value',rule.rv);
                        resultField.typedInput('type',rule.rt);
                    }

                    resultField.change( function () {
                        var rules = $("#node-input-rule-container").editableList('items');
                        
                        var showNumberHint = 0;
                        var showModifyHint = 0;
                        rules.each(function(i) {
                            var rule = $(this);
                            var type = rule.find(".node-input-rule-result").typedInput('type');
                            if (type == 'toNumber') { showNumberHint++; }
                            if (type == 'modify') { showModifyHint++; }
                        
                            if (showNumberHint == 0) {
                                $("#toNumberNote").hide();
                            } else {
                                $("#toNumberNote").show();                           
                            }
                            if (showModifyHint == 0) {
                                $("#modifyNote").hide();
                            } else {
                                $("#modifyNote").show();                           
                            }
                        });
                    });
                    resultField.trigger('change');
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true,
                addButton: "Rule"
}           );
            //Add output
            var stateType = {
                value: "state",
                label: "item state",
                hasValue: false
            };
            $('#node-input-outputValue').typedInput({
                default: 'state',
                typeField: $("#node-input-outputType"),
                types: [stateType,'msg']
            });
            if (this.outputType) {
                $("#node-input-outputValue").typedInput('type',this.outputType);
            }
            if (this.outputValue) {
                $("#node-input-outputValue").typedInput('value',this.outputValue);
            } 

            //Add bootstrap
            $('#node-input-bootstrapValue').typedInput({
                default: 'str',
                typeField: $("#node-input-bootstrapType"),
                types: ['str','json','flow','global','num','bool']
            });
            if (this.bootstrapType) {
                $("#node-input-bootstrapValue").typedInput('type',this.bootstrapType);
            }
            if (this.bootstrapValue) {
                $("#node-input-bootstrapValue").typedInput('value',this.bootstrapValue);
            } 

            //Add rules
            for (var i=0; i<this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',rule);
            }

            //Show/Hide output field
            $("#node-input-output").change( function() {
                if ($("#node-input-output").is(":checked")) {
                    $("#outputValue").show();
                    $("#bootstrap").show();
                } else {
                    $("#outputValue").hide();
                    $("#node-input-bootstrap").prop('checked', false);
                    $("#bootstrap").hide();
                    $("#bootstrapValue").hide();
                }
            });
            //Show/Hide bootstrap field
            $("#node-input-bootstrap").change( function() {
                if ($("#node-input-bootstrap").is(":checked")) {
                    $("#bootstrapValue").show();
                } else {
                    $("#bootstrapValue").hide();
                }
            });
        },
        oneditsave: function () {
            var node = this;
            if ($("#node-input-output").is(":checked")) {
                node.outputs = 1;
            } else {
                node.outputs = 0;
            }
            var rules = $("#node-input-rule-container").editableList('items');
            var ruleset;
            node.rules= [];
            rules.each(function(i) {
                var rule = $(this);
                var r = {
                    cv:rule.find(".node-input-rule-compare").typedInput('value'),
                    ct:rule.find(".node-input-rule-compare").typedInput('type'),
                    rv:rule.find(".node-input-rule-result").typedInput('value'),
                    rt:rule.find(".node-input-rule-result").typedInput('type')
                }
                node.rules.push(r);
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="item">
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-config" style="width:70%" placeholder="Event config">
    </div>

    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="Topic" style="width=70%">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-filter" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-filter" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-filter"></i> Filter on Topic</label>
    </div>
    <div class="form-row">
        <label for="node-input-identifier"><i class="fa fa-id-card-o"></i> Identifier</label>
        <input type="text" id="node-input-identifier" placeholder="Identifier" style="width=70%">
    </div>
    <div class="form-row">
        <label for="node-input-stateProperty"><i class="fa fa-sign-in"></i> State</label>
        <input type="text" id="node-input-stateProperty" placeholder="payload" style="width:70%>
        <input type="hidden" id="node-input-propertyType">
    </div>
    <div class="form-row">
        <label for="conditions-ol"><i class="fa fa-sign-in"></i> Rules</label>
        <div id="rule-ol" style="width:70%;display: inline-block;vertical-align: top;">
        <ol id="node-input-rule-container"</ol>
        </div>
        <div class="form-tips" id="toNumberNote" hidden style="margin-top: 5px;"><b>Note:</b> Convert to number can only be used on string values</div>
        <div class="form-tips" id="modifyNote" hidden style="margin-top: 5px;"><b>Note:</b> Modify example: '/10' '*100' '+20'</div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:70%">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-output" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-sign-out"></i> Use output</label>
    </div>
    <div class="form-row" id="outputValue">
        <label for="node-input-outputValue"><i class="fa fa-sign-out"></i> Output</label>
        <input type="text" id="node-input-outputValue" placeholder="payload" style="width:70%">
        <input type="hidden" id="node-input-outputType">
    </div>
    <div class="form-row" id="bootstrap">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-bootstrap" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-bolt"></i> Send bootstrap msg</label>
    </div>
    <div class="form-row" id="bootstrapValue">
        <label for="node-input-bootstrapValue"><i class="fa fa-code"></i> Bootstrap</label>
        <input type="text" id="node-input-bootstrapValue" style="width:70%">
        <input type="hidden" id="node-input-bootstrapType">
    </div>
</script>

<script type="text/x-red" data-help-name="item">
    <p>The Item node represents a single device function, like a switch or a thermometer. It can be queried by the <i>Value</i>, <i>Gate</i> and <i>Bundle</i> nodes and can trigger an event using <i>Event</i> nodes.</p>
    <li><strong>Config</strong>: Used for firing events between nodes. Use the same config for all nodes that should be able to communicate.</li>
    <li><strong>Topic</strong>: An optional property that can be configured in the node or, if left blank, can be set by <code>msg.topic</code>. If <em>Filter on Topic</em> is selected <code>msg.topic</code> of incoming messages must match the configured value for the message to be accepted.</li>
    <li><strong>Identity</strong>: An optional property that can be configured in the node or, if left blank, can be set by <code>msg.id</code>. If set, the prorerty is added to the output message as <code>msg.id</code> and can for example be used to identify a specific item when using the <i>Bundle</i> node.</li>
    <li><strong>State</strong>: Select which property from the incoming <code>msg.payload</code> to be used as the <i>Item state</i> value. The <i>Item</i> node always saves the whole <code>msg.payload</code> object, and another property can be used as output from a Value node if so desired.</li>
    <li><strong>Rules</strong>: Rules can be used to modify the <i>Item state</i> value in a variety of ways using a simple if-then formula. If no matching rule is found the <i>Item state</i> value will be unchanged. If more than one matching rule is found they will be executed in order from the top down.</li>
    <li><strong>Use output</strong> can be selected to send the incoming value further to another node. The <i>state</i> value is sent on by default, but any property in the <code>msg.payload</code> object can be selected.</li>
    <li><strong>Send bootstrap msg</strong> can be selected to send an initial bootstrap msg at startup.</li>

    <li><strong>Name</strong>: Node name, used to select the Item in <i>Value</i>, <i>Gate</i>, <i>Bundle</i> and <i>Event</i> nodes.</li>    
</script>
