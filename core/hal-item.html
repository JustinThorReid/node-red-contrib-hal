<script type="text/javascript">
    RED.nodes.registerType('item', {
        category: 'Home Automation',
        color: '#EBA8FF',
        defaults: {
            config: {
                value: "Event config",
                type: "event-config",
                required: true
            },
            name: {
                value: "",
                required: true
            },
            topic: {
                value: ""
            },
            filter: {
                value: false
            },
            identifier: {
                value: "",
                required: false
            },
            output: {
                value: false,
                required: true
            },
            outputValue: {
                value: "payload",
                required: false
            },
            outputType: {
                required: true
            },
            bootstrap: {
                value: false,
                required: true
            },
            bootstrapValue: {},
            bootstrapType: {},
            stateProperty: {
                required: true
            },
            outputs: {
                value: 0
            } //Storing if outputs is enabled.
        },
        inputs: 1,
        outputs: 0,
        icon: "hal-item.png",
        label: function () {
            return this.name || "item";
        },
        oneditprepare: function () { 
            //Add property
            if (this.stateProperty) {
                $("#node-input-stateProperty").val(this.stateProperty);
                $('#node-input-stateProperty').trigger('change');                
            } else {
                $("#node-input-stateProperty").val("payload");
                $('#node-input-stateProperty').trigger('change');    
            }
            $('#node-input-stateProperty').typedInput({
                default: 'msg',
                types: ['msg']
            });

            //Add output
            var stateType = {
                value: "state",
                label: "item state",
                hasValue: false
            };
            $('#node-input-outputValue').typedInput({
                default: 'state',
                typeField: $("#node-input-outputType"),
                types: [stateType,'msg']
            });
            if (this.outputType) {
                $("#node-input-outputValue").typedInput('type',this.outputType);
            }
            if (this.outputValue) {
                $("#node-input-outputValue").typedInput('value',this.outputValue);
            } 
            //Add bootstrap
            $('#node-input-bootstrapValue').typedInput({
                default: 'json',
                typeField: $("#node-input-bootstrapType"),
                types: ['json','flow','global','str','num','bool']
            });
            if (this.bootstrapType) {
                $("#node-input-bootstrapValue").typedInput('type',this.bootstrapType);
            }
            if (this.bootstrapValue) {
                $("#node-input-bootstrapValue").typedInput('value',this.bootstrapValue);
            } 

            //Show/Hide output field
            $("#node-input-output").change( function() {
                if ($("#node-input-output").is(":checked")) {
                    $("#outputValue").show();
                    $("#bootstrap").show();
                } else {
                    $("#outputValue").hide();
                    $("#node-input-bootstrap").prop('checked', false);
                    $("#bootstrap").hide();
                    $("#bootstrapValue").hide();
                }
            });
            //Show/Hide bootstrap field
            $("#node-input-bootstrap").change( function() {
                if ($("#node-input-bootstrap").is(":checked")) {
                    $("#bootstrapValue").show();
                } else {
                    $("#bootstrapValue").hide();
                }
            });
        },
        oneditsave: function () {
            var node = this;
            if ($("#node-input-output").is(":checked")) {
                node.outputs = 1;
            } else {
                node.outputs = 0;
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="item">
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-config" style="width:70%" placeholder="Event config">
    </div>

    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="Topic" style="width=70%">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-filter" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-filter" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-filter"></i> Filter on Topic</label>
    </div>
    <div class="form-row">
        <label for="node-input-identifier"><i class="fa fa-id-card-o"></i> Identifier</label>
        <input type="text" id="node-input-identifier" placeholder="Identifier" style="width=70%">
    </div>
    <div class="form-row">
        <label for="node-input-stateProperty"><i class="fa fa-sign-in"></i> State</label>
        <input type="text" id="node-input-stateProperty" placeholder="payload" style="width:70%>
        <input type="hidden" id="node-input-propertyType">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-output" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-sign-out"></i> Use output</label>
    </div>
    <div class="form-row" id="outputValue">
        <label for="node-input-outputValue"><i class="fa fa-sign-out"></i> Output</label>
        <input type="text" id="node-input-outputValue" placeholder="payload" style="width:70%">
        <input type="hidden" id="node-input-outputType">
    </div>
    <div class="form-row" id="bootstrap">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-bootstrap" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-sign-out"></i> Send msg on startup</label>
    </div>
    <div class="form-row" id="bootstrapValue">
        <label for="node-input-bootstrapValue"><i class="fa fa-sign-out"></i> Startmsg</label>
        <input type="text" id="node-input-bootstrapValue" style="width:70%">
        <input type="hidden" id="node-input-bootstrapType">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" style="width:70%">
    </div>
</script>

<script type="text/x-red" data-help-name="item">
    <p>The Item node represents a single device function, like a switch or a thermometer. It can be queried by the <i>Value</i>, <i>Gate</i> and <i>Bundle</i> nodes and can trigger an event using <i>Event</i> nodes.</p>
    <li><strong>Config</strong>: Used for firing events between nodes. Use the same config for all nodes that should be able to communicate.</li>
    <li><strong>Topic</strong>: An optional property that can be configured in the node or, if left blank, can be set by <code>msg.topic</code>. If <em>Filter on Topic</em> is selected <code>msg.topic</code> of incoming messages must match the configured value for the message to be accepted.</li>
    <li><strong>Identity</strong>: An optional property that can be configured in the node or, if left blank, can be set by <code>msg.id</code>. If set, the prorerty is added to the output message as <code>msg.id</code> and can for example be used to identify a specific item when using the <i>Bundle</i> node.</li>
    <li><strong>State</strong>: Select which property from the incoming <code>msg</code> to be used as the <i>Item state</i> value, usually <code>msg.payload</code>. The <i>Item</i> node always saves the whole <code>msg</code> object, and another property can be used as output from a Value node if so desired.</li>
    <li><strong>Use output</strong> can be selected to send the incoming value further to another node. The <i>state</i> value is sent on by default, but any property in the <code>msg</code> object can be selected.</li>
    <li>If outpout is used <strong>Send msg on startup</strong> can be selected to send an initial msg further to another node at startup.</li>

    <li><strong>Name</strong>: Node name, used to select the Item in <i>Value</i>, <i>Gate</i>, <i>Bundle</i> and <i>Event</i> nodes.</li>    
</script>
